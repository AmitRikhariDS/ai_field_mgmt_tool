<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Reports - AI Field Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .summary-card { border-radius: 8px; padding: 1rem; text-align: center; }
    .summary-card h4 { margin: 0; }
    .filter-card { border-radius: 8px; padding: 1rem; margin-bottom: 20px; }
  </style>
</head>
<body>
<div class="container mt-4">

<!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand ms-3 fw-bold" href="/">
        <i class="fas fa-microchip me-2 text-primary"></i> Reports Management
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-bell"></i>
              <span class="badge bg-danger rounded-pill">3</span>
            </a>
          </li>
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=3498db&color=fff" alt="User" class="rounded-circle" width="30">
              <span class="ms-2">{{ user.username }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Filters -->
  <div class="card filter-card mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-2">
        <label>Date From</label>
        <input type="date" id="filterDateFrom" class="form-control">
      </div>
      <div class="col-md-2">
        <label>Date To</label>
        <input type="date" id="filterDateTo" class="form-control">
      </div>
      <div class="col-md-2">
        <label>Status</label>
        <select id="filterStatus" class="form-select">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="scheduled">Scheduled</option>
          <option value="in_progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>
      </div>
      <div class="col-md-3">
        <label>Client</label>
        <select id="filterClient" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label>Engineer</label>
        <select id="filterEngineer" class="form-select"></select>
      </div>
    </div>
    <div class="mt-3 text-end">
      <button id="btnExport" class="btn btn-success"><i class="fa-solid fa-download"></i> Export CSV</button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-3" id="summaryCards"></div>

  <!-- Report Table -->
  <div class="card">
    <div class="card-header bg-white"><h5 class="mb-0">Report</h5></div>
    <div class="card-body p-0">
      <table class="table table-striped table-hover mb-0" id="reportTable">
        <thead>
          <tr>
            <th>Job Code</th>
            <th>Title</th>
            <th>Client</th>
            <th>Engineer</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Scheduled Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const reportTableBody = document.querySelector("#reportTable tbody");
  const filterStatus = document.querySelector("#filterStatus");
  const filterClient = document.querySelector("#filterClient");
  const filterEngineer = document.querySelector("#filterEngineer");
  const filterDateFrom = document.querySelector("#filterDateFrom");
  const filterDateTo = document.querySelector("#filterDateTo");
  const summaryCards = document.querySelector("#summaryCards");

  let allJobs = [];
  let allClients = [];
  let allEngineers = [];

  // Load Clients
  fetch("/api/clients/").then(res => res.json()).then(data => {
    allClients = data;
    filterClient.innerHTML = '<option value="">All Clients</option>';
    data.forEach(c => filterClient.innerHTML += `<option value="${c.id}">${c.name}</option>`);
  });

  // Load Engineers
  fetch("/api/engineers/").then(res => res.json()).then(data => {
    allEngineers = data;
    filterEngineer.innerHTML = '<option value="">All Engineers</option>';
    data.forEach(e => filterEngineer.innerHTML += `<option value="${e.id}">${e.name}</option>`);
  });

  // Load Jobs
  function loadJobs() {
    fetch("/api/jobs/").then(res => res.json()).then(data => {
      allJobs = data;
      renderJobs(allJobs);
      renderSummary(allJobs);
    });
  }

  // Render Jobs Table
  function renderJobs(jobs) {
    reportTableBody.innerHTML = "";
    jobs.forEach(job => {
      const clientName = job.client?.name || "-";
      const engineerName = job.engineer?.name || "-";
      reportTableBody.innerHTML += `
        <tr>
          <td>${job.job_code}</td>
          <td>${job.title}</td>
          <td>${clientName}</td>
          <td>${engineerName}</td>
          <td>${job.status}</td>
          <td>${job.priority}</td>
          <td>${job.scheduled_date}</td>
        </tr>`;
    });
  }

  // Render Summary Cards
  function renderSummary(jobs) {
    const total = jobs.length;
    const pending = jobs.filter(j => j.status === "pending").length;
    const completed = jobs.filter(j => j.status === "completed").length;
    summaryCards.innerHTML = `
      <div class="col-md-3"><div class="summary-card bg-light">Total Jobs<br><h4>${total}</h4></div></div>
      <div class="col-md-3"><div class="summary-card bg-warning text-dark">Pending<br><h4>${pending}</h4></div></div>
      <div class="col-md-3"><div class="summary-card bg-success text-white">Completed<br><h4>${completed}</h4></div></div>
    `;
  }

  // Multi-filter
  [filterStatus, filterClient, filterEngineer, filterDateFrom, filterDateTo].forEach(f => f.addEventListener("change", applyFilters));

  function applyFilters() {
    let filtered = allJobs;
    if (filterStatus.value) filtered = filtered.filter(j => j.status === filterStatus.value);
    if (filterClient.value) filtered = filtered.filter(j => j.client?.id == filterClient.value);
    if (filterEngineer.value) filtered = filtered.filter(j => j.engineer?.id == filterEngineer.value);
    if (filterDateFrom.value) filtered = filtered.filter(j => j.scheduled_date >= filterDateFrom.value);
    if (filterDateTo.value) filtered = filtered.filter(j => j.scheduled_date <= filterDateTo.value);
    renderJobs(filtered);
    renderSummary(filtered);
  }

  // Export CSV
  document.querySelector("#btnExport").addEventListener("click", () => {
    let csv = "Job Code,Title,Client,Engineer,Status,Priority,Scheduled Date\n";
    reportTableBody.querySelectorAll("tr").forEach(tr => {
      const row = Array.from(tr.children).map(td => td.innerText);
      csv += row.join(",") + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "job_report.csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  loadJobs();
});
</script>
</body>
</html>
