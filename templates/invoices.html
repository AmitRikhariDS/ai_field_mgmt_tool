<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoices - GlobalXperts</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { background: #f8f9fa; padding: 20px; }
.invoice-box { max-width: 800px; margin: auto; background: #fff; border: 1px solid #eee; padding: 20px; margin-bottom: 20px; }
.invoice-header { border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
.table th, .table td { vertical-align: middle !important; }
</style>
</head>
<body>
<!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand ms-3 fw-bold" href="/">
        <i class="fas fa-microchip me-2 text-primary"></i> Invoice Management
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-bell"></i>
              <span class="badge bg-danger rounded-pill">3</span>
            </a>
          </li>
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=3498db&color=fff" alt="User" class="rounded-circle" width="30">
              <span class="ms-2">{{ user.username }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
<br><br>
<br><br>
<div class="container">
  
  <!-- Generate Invoice Form -->
  <div class="invoice-box">
    <h4>Generate New Invoice</h4>
    <form id="invoiceForm" class="mb-3">
      <div class="row mb-2">
        <div class="col-md-6">
          <label>Client Name</label>
          <input type="text" class="form-control" id="clientName" required>
        </div>
        <div class="col-md-6">
          <label>Engineer Name</label>
          <select class="form-control" id="engineerName" required></select>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-md-6">
          <label>Job Title</label>
          <select class="form-control" id="jobTitle" required></select>
        </div>
        <div class="col-md-6">
          <label>Invoice Date</label>
          <input type="date" class="form-control" id="invoiceDate" required>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-md-4">
          <label>Hours Worked</label>
          <input type="number" step="0.01" class="form-control" id="hoursWorked" required>
        </div>
        <div class="col-md-4">
          <label>Per Hour Charge (₹)</label>
          <input type="number" step="0.01" class="form-control" id="perHourCharge" required>
        </div>
        <div class="col-md-4">
          <label>Total Amount (₹)</label>
          <input type="number" step="0.01" class="form-control" id="totalAmount" readonly>
        </div>
      </div>
      <div class="text-end mt-3">
        <button type="button" class="btn btn-success" onclick="saveAndDownloadInvoice()">Generate & Download</button>
      </div>
    </form>
  </div>

  <!-- Invoice Preview / PDF Structure -->
  <div id="invoicePreview" class="invoice-box" style="display:none;">
    <div class="invoice-header text-center">
      <strong>GlobalXperts Technology Pvt. Ltd.</strong><br>
      113, Centrum Plaza, Golf Course Road<br>
      Sector 53, Gurugram, Haryana 122002, India
    </div>
    <div class="row mb-2">
      <div class="col-md-6">
        <h5>Bill To:</h5>
        <p id="previewClient"></p>
      </div>
      <div class="col-md-6 text-end">
        <h5>Engineer:</h5>
        <p id="previewEngineer"></p>
      </div>
    </div>
    <p><strong>Invoice Date:</strong> <span id="previewDate"></span></p>
    <p><strong>Job Title:</strong> <span id="previewJob"></span></p>
    <table class="table table-bordered mt-3">
      <thead>
        <tr>
          <th>Hours Worked</th>
          <th>Rate per Hour (₹)</th>
          <th>Total Amount (₹)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="previewHours"></td>
          <td id="previewRate"></td>
          <td id="previewTotal"></td>
        </tr>
      </tbody>
    </table>
    <h5 class="text-end">Grand Total: ₹<span id="previewGrandTotal"></span></h5>
  </div>

  <!-- List of All Invoices -->
  <div class="mt-5">
    <h4>Generated Invoices</h4>
    <table class="table table-striped" id="invoiceTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Invoice Date</th>
          <th>Client</th>
          <th>Engineer</th>
          <th>Job</th>
          <th>Total Amount (₹)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invoiceList"></tbody>
    </table>
  </div>

</div>

<script>
const hoursInput = document.getElementById('hoursWorked');
const rateInput = document.getElementById('perHourCharge');
const totalInput = document.getElementById('totalAmount');

// Auto-calculate total
function calculateTotal() {
  const hours = parseFloat(hoursInput.value) || 0;
  const rate = parseFloat(rateInput.value) || 0;
  totalInput.value = (hours * rate).toFixed(2);
}
hoursInput.addEventListener('input', calculateTotal);
rateInput.addEventListener('input', calculateTotal);

// Populate engineers and jobs from backend
function loadEngineersAndJobs() {
  fetch('/api/engineers/')
    .then(res => res.json())
    .then(data => {
      const engineerSelect = document.getElementById('engineerName');
      engineerSelect.innerHTML = '';
      data.forEach(e => {
        engineerSelect.innerHTML += `<option value="${e.name}">${e.name}</option>`;
      });
    });

  fetch('/api/jobs/')
    .then(res => res.json())
    .then(data => {
      const jobSelect = document.getElementById('jobTitle');
      jobSelect.innerHTML = '';
      data.forEach(j => {
        jobSelect.innerHTML += `<option value="${j.title}">${j.title}</option>`;
      });
    });
}

// Generate preview
function generatePreview() {
  document.getElementById('invoicePreview').style.display = 'block';
  document.getElementById('previewClient').innerText = document.getElementById('clientName').value;
  document.getElementById('previewEngineer').innerText = document.getElementById('engineerName').value;
  document.getElementById('previewJob').innerText = document.getElementById('jobTitle').value;
  document.getElementById('previewDate').innerText = document.getElementById('invoiceDate').value;
  document.getElementById('previewHours').innerText = hoursInput.value;
  document.getElementById('previewRate').innerText = rateInput.value;
  document.getElementById('previewTotal').innerText = totalInput.value;
  document.getElementById('previewGrandTotal').innerText = totalInput.value;
}

// Save invoice to backend + download structured PDF
async function saveAndDownloadInvoice() {
  generatePreview();

  const invoiceData = {
    client: document.getElementById('clientName').value,
    engineer: document.getElementById('engineerName').value,
    job: document.getElementById('jobTitle').value,
    date: document.getElementById('invoiceDate').value,
    hours_worked: parseFloat(document.getElementById('hoursWorked').value),
    per_hour_charge: parseFloat(document.getElementById('perHourCharge').value),
    total_amount: parseFloat(document.getElementById('totalAmount').value),
    status: "Generated"
  };

  try {
    // Save invoice
    const response = await fetch('/api/invoices/create/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(invoiceData)
});


    const createdInvoice = await response.json();

    alert('Invoice saved successfully!');

    // Reload invoice list after creation
    loadInvoices();

    // Download PDF after saving
    html2pdf().set({
      margin: 10,
      filename: `Invoice-${invoiceData.date}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
    }).from(document.getElementById('invoicePreview')).save();

  } catch (error) {
    console.error('Error saving invoice:', error);
    alert('Failed to save invoice!');
  }
}

// Load all invoices
function loadInvoices() {
  fetch('/api/invoices/')
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('invoiceList');
      tbody.innerHTML = '';
      data.forEach((inv, index) => {
        tbody.innerHTML += `
          <tr>
            <td>${index+1}</td>
            <td>${inv.date}</td>
            <td>${inv.client}</td>
            <td>${inv.engineer}</td>
            <td>${inv.job}</td>
            <td>${inv.total_amount}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="downloadExistingInvoice(${inv.id})">Download PDF</button>
            </td>
          </tr>
        `;
      });
    });
}

// Download existing invoice
function downloadExistingInvoice(invoiceId) {
  fetch(`/api/invoices/${invoiceId}/`)
    .then(res => res.json())
    .then(inv => {
      document.getElementById('clientName').value = inv.client;
      document.getElementById('engineerName').value = inv.engineer;
      document.getElementById('jobTitle').value = inv.job;
      document.getElementById('invoiceDate').value = inv.date;
      document.getElementById('hoursWorked').value = inv.hours_worked;
      document.getElementById('perHourCharge').value = inv.per_hour_charge;
      calculateTotal();
      generatePreview();

      html2pdf().set({
        margin: 10,
        filename: `Invoice-${inv.date}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
      }).from(document.getElementById('invoicePreview')).save();
    });
}

// Initial load
loadEngineersAndJobs();
loadInvoices();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
