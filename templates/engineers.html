<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Engineers - AI Field Management</title>
<meta name="csrf-token" content="{{ csrf_token }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { background-color: #f8f9fa; }
  .engineer-card {
    border-radius: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    padding: 1rem; margin-bottom: 20px; min-height: 480px;
    display: flex; flex-direction: column; justify-content: space-between;
    background-color: #fff; transition: transform 0.2s, box-shadow 0.2s;
  }
  .engineer-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
  .badge-online { background-color: #198754; }
  .badge-offline { background-color: #dc3545; }
  .badge-skill { background-color: #0d6efd; margin-right: 3px; }
  .badge-cert { background-color: #fd7e14; margin-right: 3px; }
  .engineer-img { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; }
  .filter-row .col-md-3 { margin-bottom: 10px; }
  .img-preview { width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc; margin-top: 5px; }
</style>
</head>
<body>
<!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand ms-3 fw-bold" href="/">
        <i class="fas fa-microchip me-2 text-primary"></i> Engineer Management
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-bell"></i>
              <span class="badge bg-danger rounded-pill">3</span>
            </a>
          </li>
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=3498db&color=fff" alt="User" class="rounded-circle" width="30">
              <span class="ms-2">{{ user.username }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>
<br><br>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Engineers</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#engineerModal" onclick="openAddModal()">
      <i class="fa-solid fa-plus"></i> Add Engineer
    </button>
  </div>

  <!-- Filters -->
  <div class="row filter-row g-2 mb-3">
    <div class="col-md-3"><input type="text" class="form-control" id="filterName" placeholder="Name"></div>
    <div class="col-md-3"><input type="text" class="form-control" id="filterSkills" placeholder="Skills"></div>
    <div class="col-md-3"><input type="text" class="form-control" id="filterEducation" placeholder="Education"></div>
    <div class="col-md-3"><input type="number" class="form-control" id="filterExperience" placeholder="Experience (Years)"></div>
  </div>

  <!-- Engineers Cards -->
  <div class="row" id="engineersContainer"></div>
</div>

<!-- Modal for Add/Edit Engineer -->
<div class="modal fade" id="engineerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalTitle"><i class="fa-solid fa-plus"></i> Add Engineer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="engineerForm" enctype="multipart/form-data">
          <input type="hidden" id="engineerId">
          <div class="row g-3">
            <div class="col-md-4"><label class="form-label">Name</label><input type="text" class="form-control" id="engineerName" required></div>
            <div class="col-md-4"><label class="form-label">Phone</label><input type="text" class="form-control" id="engineerPhone" required></div>
            <div class="col-md-4"><label class="form-label">Status</label>
              <select class="form-select" id="engineerStatus">
                <option value="online">Online</option>
                <option value="offline">Offline</option>
              </select>
            </div>
            <div class="col-md-4"><label class="form-label">Country</label><input type="text" class="form-control" id="engineerCountry"></div>
            <div class="col-md-4"><label class="form-label">Primary Skills</label><input type="text" class="form-control" id="engineerSkills" placeholder="Comma-separated"></div>
            <div class="col-md-4"><label class="form-label">Certifications</label><input type="text" class="form-control" id="engineerCerts" placeholder="Comma-separated"></div>
            <div class="col-md-4"><label class="form-label">Education</label><input type="text" class="form-control" id="engineerEducation"></div>
            <div class="col-md-4"><label class="form-label">Work Experience</label><input type="number" class="form-control" id="engineerExperience"></div>
            <div class="col-md-4"><label class="form-label">Summary</label><textarea class="form-control" id="engineerSummary" rows="2"></textarea></div>
            <div class="col-md-4">
              <label class="form-label">Profile Image</label>
              <input type="file" class="form-control" id="engineerImage" accept="image/*">
              <img id="imagePreview" class="img-preview" src="#" alt="Image Preview" style="display:none;">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" form="engineerForm" class="btn btn-success"><i class="fa-solid fa-save"></i> Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
// CSRF helper
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener("DOMContentLoaded", () => {
  const engineersContainer = document.querySelector("#engineersContainer");
  const form = document.getElementById("engineerForm");
  const imageInput = document.getElementById("engineerImage");
  const imagePreview = document.getElementById("imagePreview");
  const modalTitle = document.getElementById("modalTitle");
  const engineerIdInput = document.getElementById("engineerId");

  const filterName = document.querySelector("#filterName");
  const filterSkills = document.querySelector("#filterSkills");
  const filterEducation = document.querySelector("#filterEducation");
  const filterExperience = document.querySelector("#filterExperience");

  let allEngineers = [];

  function loadEngineers() {
    fetch("/api/engineers/")
      .then(res => res.json())
      .then(data => { allEngineers = data; renderEngineers(allEngineers); });
  }

  function renderEngineers(engineers) {
    engineersContainer.innerHTML = "";
    engineers.forEach(e => {
      const statusClass = `badge-${e.status}`;
      const skills = e.primary_skills ? e.primary_skills.split(",").map(s => `<span class="badge badge-skill">${s.trim()}</span>`).join(" ") : "-";
      const certs = e.certifications ? e.certifications.split(",").map(c => `<span class="badge badge-cert">${c.trim()}</span>`).join(" ") : "-";
      const img = e.image ? `<img src="${e.image}" class="engineer-img">` : `<div class="engineer-img bg-secondary d-flex align-items-center justify-content-center text-white">No Image</div>`;
      engineersContainer.innerHTML += `
        <div class="col-md-4">
          <div class="engineer-card">
            ${img}
            <div>
              <h6>${e.name}</h6>
              <p><strong>Phone:</strong> ${e.phone || "-"}</p>
              <p>Status: <span class="badge ${statusClass}">${e.status}</span></p>
              <p><strong>Country:</strong> ${e.country || "-"}</p>
              <p><strong>Skills:</strong> ${skills}</p>
              <p><strong>Certifications:</strong> ${certs}</p>
              <p><strong>Education:</strong> ${e.education || "-"}</p>
              <p><strong>Experience:</strong> ${e.work_experience || "-"}</p>
              <p><strong>Summary:</strong> ${e.summary || "-"}</p>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <button class="btn btn-sm btn-warning" onclick="openEditModal(${e.id})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteEngineer(${e.id})">Delete</button>
            </div>
          </div>
        </div>`;
    });
  }

  function filterEngineers() {
    const nameQ = filterName.value.toLowerCase();
    const skillsQ = filterSkills.value.toLowerCase();
    const eduQ = filterEducation.value.toLowerCase();
    const expQ = filterExperience.value;
    const filtered = allEngineers.filter(e => {
      const nameMatch = e.name.toLowerCase().includes(nameQ);
      const skillsMatch = !skillsQ || (e.primary_skills && e.primary_skills.toLowerCase().includes(skillsQ));
      const eduMatch = !eduQ || (e.education && e.education.toLowerCase().includes(eduQ));
      const expMatch = !expQ || (e.work_experience && parseInt(e.work_experience) >= parseInt(expQ));
      return nameMatch && skillsMatch && eduMatch && expMatch;
    });
    renderEngineers(filtered);
  }

  filterName.addEventListener("input", filterEngineers);
  filterSkills.addEventListener("input", filterEngineers);
  filterEducation.addEventListener("input", filterEngineers);
  filterExperience.addEventListener("input", filterEngineers);

  window.deleteEngineer = function(id) {
    if (!confirm("Delete this engineer?")) return;
    fetch(`/api/engineers/${id}/`, { method: "DELETE", headers: {'X-CSRFToken': csrftoken} })
      .then(() => loadEngineers());
  }

  window.openAddModal = function() {
    modalTitle.innerHTML = `<i class="fa-solid fa-plus"></i> Add Engineer`;
    engineerIdInput.value = "";
    form.reset();
    imagePreview.style.display = "none";
  }

  window.openEditModal = function(id) {
    const engineer = allEngineers.find(e => e.id === id);
    if (!engineer) return;
    modalTitle.innerHTML = `<i class="fa-solid fa-edit"></i> Edit Engineer`;
    engineerIdInput.value = engineer.id;
    document.getElementById("engineerName").value = engineer.name;
    document.getElementById("engineerPhone").value = engineer.phone;
    document.getElementById("engineerStatus").value = engineer.status;
    document.getElementById("engineerCountry").value = engineer.country;
    document.getElementById("engineerSkills").value = engineer.primary_skills;
    document.getElementById("engineerCerts").value = engineer.certifications;
    document.getElementById("engineerEducation").value = engineer.education;
    document.getElementById("engineerExperience").value = engineer.work_experience;
    document.getElementById("engineerSummary").value = engineer.summary;
    if (engineer.image) { imagePreview.src = engineer.image; imagePreview.style.display = "block"; }
    else { imagePreview.style.display = "none"; }
    new bootstrap.Modal(document.getElementById('engineerModal')).show();
  }

  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (file) { imagePreview.src = URL.createObjectURL(file); imagePreview.style.display = "block"; }
  });

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const id = engineerIdInput.value;
    const formData = new FormData();
    formData.append("name", document.getElementById("engineerName").value);
    formData.append("phone", document.getElementById("engineerPhone").value);
    formData.append("status", document.getElementById("engineerStatus").value);
    formData.append("country", document.getElementById("engineerCountry").value);
    formData.append("primary_skills", document.getElementById("engineerSkills").value);
    formData.append("certifications", document.getElementById("engineerCerts").value);
    formData.append("education", document.getElementById("engineerEducation").value);
    formData.append("work_experience", document.getElementById("engineerExperience").value);
    formData.append("summary", document.getElementById("engineerSummary").value);
    if (imageInput.files[0]) formData.append("image", imageInput.files[0]);

    try {
      const url = id ? `/api/engineers/${id}/` : `/api/engineers/`;
      const method = id ? "PUT" : "POST";
      const res = await fetch(url, { method, headers: {'X-CSRFToken': csrftoken}, body: formData });
      if (!res.ok) { const err = await res.json(); throw new Error(JSON.stringify(err)); }
      bootstrap.Modal.getInstance(document.getElementById('engineerModal')).hide();
      loadEngineers();
    } catch (err) { alert("Error saving engineer: " + err.message); console.error(err); }
  });

  loadEngineers();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
