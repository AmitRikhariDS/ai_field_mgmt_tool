<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Jobs - AI Field Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    .job-card {
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
      background-color: #fff;
    }
    .job-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .badge-pending { background-color: #ffc107; color: #212529; }
    .badge-scheduled { background-color: #0d6efd; }
    .badge-in_progress { background-color: #fd7e14; }
    .badge-completed { background-color: #198754; }
    .badge-high { background-color: #dc3545; }
    .badge-medium { background-color: #fd7e14; }
    .badge-low { background-color: #0d6efd; }
    .search-input { max-width: 250px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand ms-3 fw-bold" href="/">
        <i class="fas fa-microchip me-2 text-primary"></i> Jobs Management
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="notificationsDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-bell"></i>
              <span class="badge bg-danger rounded-pill">3</span>
            </a>
          </li>
          <li class="nav-item dropdown me-3">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <img src="https://ui-avatars.com/api/?name=Admin+User&background=3498db&color=fff" alt="User" class="rounded-circle" width="30">
              <span class="ms-2">Admin User</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <br><br>

  <div class="container mt-4">
    <!-- Add Job Button -->
    <div class="mb-3 text-end">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addJobModal">
        <i class="fa-solid fa-plus"></i> Add Job
      </button>
    </div>

    <!-- Filters -->
    <div class="d-flex flex-wrap gap-2 mb-3">
      <select id="filterStatus" class="form-select" style="width: 180px;">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="scheduled">Scheduled</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
      </select>
      <select id="filterClient" class="form-select" style="width: 180px;">
        <option value="">All Clients</option>
      </select>
      <select id="filterEngineer" class="form-select" style="width: 180px;">
        <option value="">All Engineers</option>
      </select>
      <input type="date" id="filterDate" class="form-control" style="width: 180px;">
      <input type="text" id="jobSearch" class="form-control search-input" placeholder="Search by title..." style="width: 250px;">
    </div>

    <!-- Jobs Cards -->
    <div class="row" id="jobsContainer"></div>
  </div>

  <!-- Add Job Modal -->
  <div class="modal fade" id="addJobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="fa-solid fa-plus"></i> Add New Job</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addJobForm" class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" id="jobTitle" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Client</label>
              <select id="jobClientSelect" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Engineer</label>
              <select id="jobEngineerSelect" class="form-select"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Status</label>
              <select id="jobStatus" class="form-select" required>
                <option value="pending">Pending</option>
                <option value="scheduled">Scheduled</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Priority</label>
              <select id="jobPriority" class="form-select" required>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Scheduled Date</label>
              <input type="date" class="form-control" id="jobScheduledDate" required>
            </div>
            <div class="col-12 text-end mt-3">
              <button type="submit" class="btn btn-success"><i class="fa-solid fa-save"></i> Save Job</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Job Modal -->
  <div class="modal fade" id="editJobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Edit Job</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editJobForm" class="row g-3">
            <input type="hidden" id="editJobId">
            <div class="col-md-4">
              <label class="form-label">Title</label>
              <input type="text" id="editJobTitle" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Client</label>
              <select id="editJobClient" class="form-select" required></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Engineer</label>
              <select id="editJobEngineer" class="form-select"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Status</label>
              <select id="editJobStatus" class="form-select" required>
                <option value="pending">Pending</option>
                <option value="scheduled">Scheduled</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Priority</label>
              <select id="editJobPriority" class="form-select" required>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Scheduled Date</label>
              <input type="date" id="editJobScheduledDate" class="form-control" required>
            </div>
            <div class="col-12 text-end mt-3">
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const jobsContainer = document.querySelector("#jobsContainer");
  const searchInput = document.querySelector("#jobSearch");
  const filterStatus = document.querySelector("#filterStatus");
  const filterClient = document.querySelector("#filterClient");
  const filterEngineer = document.querySelector("#filterEngineer");
  const filterDate = document.querySelector("#filterDate");

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  let allJobs = [], clients = [], engineers = [];

  function loadClients() {
    fetch("/api/clients/").then(res => res.json()).then(data => {
      clients = data;
      const selects = [document.querySelector("#jobClientSelect"), filterClient, document.querySelector("#editJobClient")];
      selects.forEach(select => {
        select.innerHTML = '<option value="">Select Client</option>';
        data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.name}</option>`);
      });
    });
  }

  function loadEngineers() {
    fetch("/api/engineers/").then(res => res.json()).then(data => {
      engineers = data;
      const selects = [document.querySelector("#jobEngineerSelect"), filterEngineer, document.querySelector("#editJobEngineer")];
      selects.forEach(select => {
        select.innerHTML = '<option value="">Select Engineer</option>';
        data.forEach(e => select.innerHTML += `<option value="${e.id}">${e.name}</option>`);
      });
    });
  }

  function generateJobCode() { return 'JOB-' + Math.floor(1000 + Math.random() * 9000); }

  function renderJobs(jobs) {
    jobsContainer.innerHTML = "";
    jobs.forEach(job => {
      const clientName = job.client?.name || "-";
      const engineerName = job.engineer?.name || "-";
      const statusClass = `badge-${job.status}`;
      const priorityClass = `badge-${job.priority}`;
      jobsContainer.innerHTML += `
        <div class="col-md-4">
          <div class="job-card">
            <h6>${job.title}</h6>
            <p><strong>Job Code:</strong> ${job.job_code || '-'}</p>
            <p><strong>Client:</strong> ${clientName}</p>
            <p><strong>Engineer:</strong> ${engineerName}</p>
            <p><span class="badge ${statusClass}">${job.status}</span> <span class="badge ${priorityClass}">${job.priority}</span></p>
            <p><strong>Scheduled:</strong> ${job.scheduled_date}</p>
            <div class="d-flex justify-content-between mt-2">
              <button class="btn btn-sm btn-warning" onclick="openEditJob(${job.id})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteJob(${job.id})">Delete</button>
            </div>
          </div>
        </div>
      `;
    });
  }

  function applyFilters() {
    return allJobs.filter(job => {
      const matchesStatus = filterStatus.value === "" || job.status === filterStatus.value;
      const matchesClient = filterClient.value === "" || job.client?.id == filterClient.value;
      const matchesEngineer = filterEngineer.value === "" || job.engineer?.id == filterEngineer.value;
      const matchesDate = filterDate.value === "" || job.scheduled_date === filterDate.value;
      return matchesStatus && matchesClient && matchesEngineer && matchesDate;
    });
  }

  function loadJobs() {
    fetch("/api/jobs/").then(res => res.json()).then(data => {
      allJobs = data;
      renderJobs(applyFilters());
    });
  }

  function requestOptions(method, body) {
    return {
      method,
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
      body: JSON.stringify(body)
    };
  }

  // Add Job
  document.querySelector("#addJobForm").addEventListener("submit", e => {
    e.preventDefault();
    const payload = {
      job_code: generateJobCode(),
      title: document.querySelector("#jobTitle").value,
      client_id: document.querySelector("#jobClientSelect").value,
      engineer_id: document.querySelector("#jobEngineerSelect").value || null,
      status: document.querySelector("#jobStatus").value,
      priority: document.querySelector("#jobPriority").value,
      scheduled_date: document.querySelector("#jobScheduledDate").value
    };
    fetch("/api/jobs/", requestOptions("POST", payload))
      .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(JSON.stringify(err)); }))
      .then(() => {
        document.querySelector("#addJobForm").reset();
        bootstrap.Modal.getInstance(document.querySelector("#addJobModal")).hide();
        loadJobs();
      })
      .catch(err => alert("Error adding job: " + err.message));
  });

  // Delete Job
  window.deleteJob = id => {
    if (!confirm("Delete this job?")) return;
    fetch(`/api/jobs/${id}/`, { method: "DELETE", headers: { "X-CSRFToken": csrfToken } }).then(() => loadJobs());
  };

  // Open Edit Modal
  window.openEditJob = id => {
    const job = allJobs.find(j => j.id === id);
    if (!job) return;
    document.querySelector("#editJobId").value = job.id;
    document.querySelector("#editJobTitle").value = job.title;
    document.querySelector("#editJobClient").value = job.client?.id || "";
    document.querySelector("#editJobEngineer").value = job.engineer?.id || "";
    document.querySelector("#editJobStatus").value = job.status;
    document.querySelector("#editJobPriority").value = job.priority;
    document.querySelector("#editJobScheduledDate").value = job.scheduled_date;
    new bootstrap.Modal(document.querySelector("#editJobModal")).show();
  };

  // Save Edit
  document.querySelector("#editJobForm").addEventListener("submit", e => {
    e.preventDefault();
    const id = document.querySelector("#editJobId").value;
    const payload = {
      title: document.querySelector("#editJobTitle").value,
      client_id: document.querySelector("#editJobClient").value,
      engineer_id: document.querySelector("#editJobEngineer").value || null,
      status: document.querySelector("#editJobStatus").value,
      priority: document.querySelector("#editJobPriority").value,
      scheduled_date: document.querySelector("#editJobScheduledDate").value
    };
    fetch(`/api/jobs/${id}/`, requestOptions("PATCH", payload))
      .then(res => res.ok ? res.json() : res.json().then(err => { throw new Error(JSON.stringify(err)); }))
      .then(() => {
        bootstrap.Modal.getInstance(document.querySelector("#editJobModal")).hide();
        loadJobs();
      })
      .catch(err => alert("Error updating job: " + err.message));
  });

  // Filters & Search
  [filterStatus, filterClient, filterEngineer, filterDate].forEach(el => el.addEventListener("change", () => renderJobs(applyFilters())));
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    const filtered = applyFilters().filter(j =>
      j.title?.toLowerCase().includes(q) ||
      j.client?.name?.toLowerCase().includes(q) ||
      j.engineer?.name?.toLowerCase().includes(q)
    );
    renderJobs(filtered);
  });

  loadClients();
  loadEngineers();
  loadJobs();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
